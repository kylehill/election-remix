<!DOCTYPE html>
<html>
<head>
  <title>ElectionRemix.com</title>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:600' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="container">
    <div id="left">
      <div class="logo">
        <img src="logo.png" />
      </div>
      <div class="headline">
        <table>
          <thead>
            <tr>
              <td></td>
              <td>
                <div class="outside">
                  <div class="inside">
                    Electoral College
                  </div>
                </div>
              </td>
              <td><div class="outside">
                <div class="inside">
                  Winning Percentage
                </div>
              </div></td>
              <td><div class="outside">
                <div class="inside">
                  Popular Vote
                </div>
              </div></td>
            </tr>
          </thead>
          <tbody>
            <tr class="dem">
              <td class="name">Obama</td>
              <td class="well"><div id="dem_ev"></div></td>
              <td class="well"><div id="dem_wp"></div></td>
              <td class="well"><div id="dem_pv"></div></td>
            </tr>
            <tr class="rep">
              <td class="name">Romney</td>
              <td class="well"><div id="rep_ev"></div></td>
              <td class="well"><div id="rep_wp"></div></td>
              <td class="well"><div id="rep_pv"></div></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="tabs">
        <div class="tab" data-tab="nationwide">Nationwide</div>
        <div class="tab" data-tab="party">Party</div>
        <div class="tab" data-tab="race">Race</div>
        <div class="tab" data-tab="religion">Religion</div>
        <div class="tab" data-tab="economics">Economics</div>
        <div class="tab" data-tab="region">Region</div>
      </div>
      <div id="filters">
        
        <div class="filter-group" id="intro">
          <p>
            ElectionRemix is a way to project the outcome 2012 Presidential Election
          </p>
          <p>
            Click on any state or on the tabs above to get access to the filters, and start tweaking! Click the "Remix" button to finish the projections. 
          </p>
          <p>
            <span id="span-about">Who made this?</span>
          </p>
        </div>
        
        <div class="filter-group" id="about">
          <p>
            I'm Kyle Hill (
              <a target="_blank" href="http://github.com/kylehill">GitHub</a>, 
              <a target="_blank" href="http://twitter.com/kylehill">Twitter</a>, 
              <a href="mailto:kylehill@gmail.com">Email</a>, 
            ) and I slapped together ElectoralRemix for the 2012 Washington Post <a href="http://electionhackathon.com">
            Election Hackathon</a>. It's pretty quick and rather dirty, but I'll can put some UX
            spit-shine on it if there's any interest.
          </p>
          <p>
            I <a href="http://kylemhill.wordpress.com" target="_blank">blogged</a> for a while about this project, 
            and the source is up on <a href="http://github.com/kylehill/election-remix">GitHub</a>.
          </p>
          <p>
            <span style="color:red">&lt;3</span>, Kyle
          <p>
        </div>
        
        <div class="filter-group" data-group="nationwide">
          
          <div class="filter">
            <div class="outside"><div class="inside">Everyone!</div></div>
            <div class="trigger" data-trigger="all" data-style="universal">
              <div class="label dem">

              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          <div class="filter">
            <div class="outside" style="background-color:red"><div class="inside">States voting for McCain in 2008</div></div>
            <div class="trigger" data-trigger="mccain08" data-style="universal">
              <div class="label dem">
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          
          <div class="filter">
            <div class="outside" style="background-color:blue"><div class="inside">States voting for Obama in 2008</div></div>
            <div class="trigger" data-trigger="obama08" data-style="universal">
              <div class="label dem">
                
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
        </div>
        
        <div class="filter-group" data-group="party">
          
          <div class="filter">
            <div class="outside"  style="background-color:lightcoral"><div class="inside">Registered Republicans</div></div>
            <div class="trigger" data-trigger="reg_rep" data-style="demographic">
              <div class="label dem">

              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          <div class="filter">
            <div class="outside" style="background-color:paleturquoise"><div class="inside">Registered Democrats</div></div>
            <div class="trigger" data-trigger="reg_dem" data-style="demographic">
              <div class="label dem">
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          
          <div class="filter">
            <div class="outside" style="background-color:lightgreen"><div class="inside">Independents</div></div>
            <div class="trigger" data-trigger="reg_ind" data-style="demographic">
              <div class="label dem">
                
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
        </div>
        
        <div class="filter-group" data-group="race">
          
          <div class="filter">
            <div class="outside"  style="background-color:beige"><div class="inside">White</div></div>
            <div class="trigger" data-trigger="white" data-style="demographic">
              <div class="label dem">

              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          <div class="filter">
            <div class="outside" style="background-color:brown"><div class="inside">African-American</div></div>
            <div class="trigger" data-trigger="black" data-style="demographic">
              <div class="label dem">
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          
          <div class="filter">
            <div class="outside" style="background-color:tan"><div class="inside">Hispanic/Latino</div></div>
            <div class="trigger" data-trigger="hispanic" data-style="demographic">
              <div class="label dem">
                
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
        </div>
        
        
        <div class="filter-group" data-group="religion">
          
          <div class="filter">
            <div class="outside"  style="background-color:yellow"><div class="inside">Protestant</div></div>
            <div class="trigger" data-trigger="protestant" data-style="demographic">
              <div class="label dem">

              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          <div class="filter">
            <div class="outside" style="background-color:orange"><div class="inside">Catholic</div></div>
            <div class="trigger" data-trigger="catholic" data-style="demographic">
              <div class="label dem">
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          
          <div class="filter">
            <div class="outside" style="background-color:red"><div class="inside">Mormon</div></div>
            <div class="trigger" data-trigger="mormon" data-style="demographic">
              <div class="label dem">
                
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          <div class="filter">
            <div class="outside" style="background-color:steelblue"><div class="inside">Jewish</div></div>
            <div class="trigger" data-trigger="judaism" data-style="demographic">
              <div class="label dem">
                
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
        </div>
        
        <div class="filter-group" data-group="economics">
          
          <div class="filter">
            <div class="outside"  style="background-color:black"><div class="inside">Per Capita Income</div></div>
            <div class="trigger" data-trigger="per_capita" data-style="demographic">
              <div class="label dem">

              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          <div class="filter">
            <div class="outside" style="background-color:gray"><div class="inside">Poverty Rate</div></div>
            <div class="trigger" data-trigger="poverty" data-style="demographic">
              <div class="label dem">
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          
          <div class="filter">
            <div class="outside" style="background-color:silver"><div class="inside">Unemployment Rate</div></div>
            <div class="trigger" data-trigger="unemployment" data-style="demographic">
              <div class="label dem">
                
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
        </div>
        
        <div class="filter-group" data-group="region">
          
          <div class="filter">
            <div class="outside"  style="background-color:lime"><div class="inside">Northeast</div></div>
            <div class="trigger" data-trigger="northeast" data-style="demographic">
              <div class="label dem">

              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          <div class="filter">
            <div class="outside" style="background-color:deepskyblue"><div class="inside">South</div></div>
            <div class="trigger" data-trigger="south" data-style="demographic">
              <div class="label dem">
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          
          <div class="filter">
            <div class="outside" style="background-color:deeppink"><div class="inside">Midwest</div></div>
            <div class="trigger" data-trigger="midwest" data-style="demographic">
              <div class="label dem">
                
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
          <div class="filter">
            <div class="outside" style="background-color:teal"><div class="inside">West</div></div>
            <div class="trigger" data-trigger="west" data-style="demographic">
              <div class="label dem">
                
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
          
        </div>
        
        <div class="filter-group" id="highlight">
          <div class="filter">
            <div class="outside" style="background-color:black"><div class="inside">
              <span id="state-name"></span>
            </div></div>
            <div class="trigger" data-style="state">
              <div class="label dem">
                
              </div>
              <div class="switcher">
                <div class="switcher-button d">&larr;</div>
                <div class="switcher-button r">&rarr;</div>
              </div>
              <div class="label rep">

              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
    <div id="right">
      <div id="chart_div" style="width:800px; height:500px;"></div>
      <div class="button-row">
        <div class="button" id="remixer">
          Remix!
        </div>
      </div>
    </div>
    
    
  </div>
  
  <!-- Load all the libraries -->
  <script src="libs/jquery-1.8.2.min.js"></script>
  <script src="libs/underscore-min.js"></script>
  <script src="libs/jstat-1.0.0.min.js"></script>
  <script type='text/javascript' src='https://www.google.com/jsapi'></script>
  
  <!-- Load the data file -->
  <script>
    var eg2012 = {};
    eg2012.cards = {};
    eg2012.cards["38-fivethirtyeight-ccol-top"] = {
      load:function(data) {
        eg2012.data = data;
      }
    }
  </script>
  <script src="http://elections.nytimes.com/2012/cards/38-fivethirtyeight-ccol-top.js"></script>
  
  <!-- Load the code files -->
  <script src="data.js"></script>
  <script src="demographics.js"></script>
  <script src="filters.js"></script>
  <script src="population.js"></script>
  <script src="montecarlo.js"></script>
  
  <!-- Ready to rock -->
  <script>
    var originalData, filterSet = [], currentData;
    var rawData;
    
    $(document).on("ready", function(){
      
      // Massage the data
      originalData = massage(eg2012.data);
      originalData = applyDemographics(originalData, demographics);
      originalData = applyPopulation(originalData, population);
      rawData = JSON.stringify(originalData);
      
      // Apply a test filter
      currentData = simulate(applyFilters());
      render(currentData);
      
      $("#intro").show();

    });
    
    var drawMap = function() {
      var dataArray = [['State', 'Obama Win %']];
      for (var s in currentData.states) {
        var state = currentData.states[s];
        if (state.init) {
          dataArray.push([state.name, Math.round(state.wDem / currentData.runs * 10000) / 100])
        }
      }
      var data = google.visualization.arrayToDataTable(dataArray);
      var chart = new google.visualization.GeoChart(document.getElementById('chart_div'));
      chart.draw(data, {
        region:"US", 
        resolution:"provinces",
        colorAxis: {
          colors: ["lightcoral","paleturquoise"]
        },
        legend: "none",
        backgroundColor: "#eeeeee"
      });
      
      google.visualization.events.addListener(chart, 'regionClick', function(r){
        $(".tab").removeClass("active");
        var state = r.region.split("-")[1];
        var stateData = originalData[state];
        $(".filter-group").hide();
        $("#highlight").show();
        $("#highlight").find(".trigger").data("trigger", state);
        $("#state-name").text(stateData.name);
        
        $('#highlight .filter')
          .each(function(){
            var field = $(this).find(".trigger").data("trigger")
            var filter = getStateFilter(field);
            if (filter) {
              var level = filter.delta;
              if (level !== 0) {
                $(this).find(".label.dem").text("Obama " + (level > 0 ? "+" : "-") + Math.abs(level));
                $(this).find(".label.rep").text("Romney " + (level > 0 ? "-" : "+") + Math.abs(level));
              }
            } else {
              $(this).find(".label.dem").text("");
              $(this).find(".label.rep").text("");
            }
          });
      })
    }
    
    var render = function(result) {
      $("#dem_ev").text(Math.round(result.evDem * 100) / 100)
      $("#rep_ev").text(Math.round(result.evRep * 100) / 100)
      
      $("#dem_wp").text(Math.round(result.wDem * 10000) / 100 + "%")
      $("#rep_wp").text(Math.round(result.wRep * 10000) / 100 + "%")
      
      $("#dem_pv").text(Math.round(result.pvDem * 100) / 100 + "%")
      $("#rep_pv").text(Math.round(result.pvRep * 100) / 100 + "%")
      
      if (result.evDem > result.evRep) {
        $("#dem_ev").parent().addClass("lead");
        $("#rep_ev").parent().removeClass("lead");
      }
      else {
        $("#dem_ev").parent().removeClass("lead");
        $("#rep_ev").parent().addClass("lead");
      }
      
      if (result.wDem > result.wRep) {
        $("#dem_wp").parent().addClass("lead");
        $("#rep_wp").parent().removeClass("lead");
      }
      else {
        $("#dem_wp").parent().removeClass("lead");
        $("#rep_wp").parent().addClass("lead");
      }
      
      if (result.pvDem > result.pvRep) {
        $("#dem_pv").parent().addClass("lead");
        $("#rep_pv").parent().removeClass("lead");
      }
      else {
        $("#dem_pv").parent().removeClass("lead");
        $("#rep_pv").parent().addClass("lead");
      }
      
      drawMap();
    }
    
    var addUniversalFilter = function(flag, vsDemDelta){
      if (getUniversalFilter(flag) !== false) {
        console.log()
        _.each(filterSet, function(f){
          if (f.type == "u" && f.flag == flag) {
            f.delta += vsDemDelta;
          }
        });
      }
      else {
        filterSet.push({type: "u", flag: flag, delta: vsDemDelta});
      }
      
      return getUniversalFilter(flag);
    };
    
    var addDemoFilter = function(characteristic, vsDemDelta){
      if (getDemoFilter(characteristic) !== false) {
        _.each(filterSet, function(f){
          if (f.type == "d" && f.characteristic == characteristic) {
            f.delta += vsDemDelta;
          }
        });
      }
      else {
        filterSet.push({type: "d", characteristic: characteristic, delta: vsDemDelta });
      }
      return getDemoFilter(characteristic);
    };
    
    var addStateFilter = function(state, vsDemDelta){
      if (getStateFilter(state) !== false) {
        _.each(filterSet, function(f){
          if (f.type == "s" && f.state == state) {
            f.delta += vsDemDelta;
          }
        });
      }
      else {
        filterSet.push({type: "s", state: state, delta: vsDemDelta});
      }
      return getStateFilter(state);
    };
    
    var getUniversalFilter = function(flag) {
      var filter = _.find(filterSet, function(f){
        return (f.type == "u" && f.flag == flag);
      });
      return (filter || false);
    }
    
    var getDemoFilter = function(characteristic) {
      var filter = _.find(filterSet, function(f){
        return (f.type == "d" && f.characteristic == characteristic);
      });
      return (filter || false);
    }
    
    var getStateFilter = function(state) {
      var filter = _.find(filterSet, function(f){
        return (f.type == "s" && f.state == state);
      });
      return (filter || false);
    }
    
    var applyFilters = function(){
      var currentData = JSON.parse(rawData);
      _.each(filterSet, function(f){
        switch (f.type) {
          case "u":
            currentData = filters[f.flag](currentData, f.delta);
            break;
          case "s":
            currentData = filters.state(currentData, f.state, f.delta);
            break;
          case "d":
            currentData = filters.demographics(currentData, f.characteristic, f.delta);
            break;
          default:
            break;
        }
      });
      return currentData;
    };
    
    google.load('visualization', '1', {'packages': ['geochart']});
    //google.setOnLoadCallback(drawMap);
    
    $(".tab").on("click", function(){
      $(".tab").removeClass("active");
      $(this).addClass("active");
      $(".filter-group").hide();
      $('.filter-group[data-group="' + $(this).data("tab") + '"]')
        .show()
        .find(".trigger")
        .each(function(){
          var field = $(this).data("trigger");
          var style = $(this).data("style");
          var filter;
          switch(style) {
            case "universal":
              filter = getUniversalFilter(field);
              break;
            case "state":
              filter = getStateFilter(field);
              break;
            case "demographic":
              filter = getDemoFilter(field);
              break;
            default:
              break;
          }
          if (filter) {
            var level = filter.delta;
            if (level !== 0) {
              $(this).find(".label.dem").text("Obama " + (level > 0 ? "+" : "-") + Math.abs(level));
              $(this).find(".label.rep").text("Romney " + (level > 0 ? "-" : "+") + Math.abs(level));
            }
            else {
              $(trigger).find(".label.dem").text("");
              $(trigger).find(".label.rep").text("");
            }
            
          }
        });
    });
    
    $(".switcher-button").on("click", function(){
      var delta = ($(this).hasClass("d") ? .5 : -.5)
      var trigger = $(this).closest(".trigger");
      var style = $(trigger).data("style");
      var field = $(trigger).data("trigger");
      var filter;
      switch(style) {
        case "universal":
          filter = addUniversalFilter(field, delta);
          break;
        case "state":
          filter = addStateFilter(field, delta);
          break;
        case "demographic":
          filter = addDemoFilter(field, delta);
          break;
        default:
          break;
      }
      if (filter) {
        var level = filter.delta;
        if (level !== 0) {
          $(trigger).find(".label.dem").text("Obama " + (level > 0 ? "+" : "-") + Math.abs(level));
          $(trigger).find(".label.rep").text("Romney " + (level > 0 ? "-" : "+") + Math.abs(level));
        }
        else {
          $(trigger).find(".label.dem").text("");
          $(trigger).find(".label.rep").text("");
        }
      }
    });
    
    $("#remixer").on("click", function(){
      currentData = simulate(applyFilters(), 2500);
      render(currentData);
    });
    
    $("#span-about").on("click", function(){
      $("#intro").hide();
      $("#about").show();
    });
  </script>
</body>
</html>